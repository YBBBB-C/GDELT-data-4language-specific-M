
WITH english_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier,
    ARRAY_AGG(MentionTimeDate ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS MentionTimeDate
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE (MentionDocTranslationInfo = '' OR MentionDocTranslationInfo IS NULL)  
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
chinese_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:zho%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
spanish_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:spa%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
arabic_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:ara%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
)
SELECT
  en.DocumentIdentifier AS DocumentIdentifier,   
  gkg.V2Themes,
  gkg.V2Tone,
  gkg.GCAM,
  en.GLOBALEVENTID,
  CONCAT(SUBSTR(CAST(en.MentionTimeDate AS STRING), 1, 4), '-',
         SUBSTR(CAST(en.MentionTimeDate AS STRING), 5, 2), '-',
         SUBSTR(CAST(en.MentionTimeDate AS STRING), 7, 2)) AS ts,
  'en' AS lang,
  'en' AS src_lang,
  zh.DocumentIdentifier AS url_zh,  -- same event but zh URL
  es.DocumentIdentifier AS url_es,  -- es URL
  ar.DocumentIdentifier AS url_ar   -- ar URL
FROM english_docs en
JOIN chinese_docs zh ON en.GLOBALEVENTID = zh.GLOBALEVENTID
JOIN spanish_docs es ON en.GLOBALEVENTID = es.GLOBALEVENTID
JOIN arabic_docs ar  ON en.GLOBALEVENTID = ar.GLOBALEVENTID
JOIN `gdelt-bq.gdeltv2.gkg_partitioned` gkg 
     ON en.DocumentIdentifier = gkg.DocumentIdentifier
WHERE (
  gkg.V2Themes LIKE '%FINANCE%' OR 
  gkg.V2Themes LIKE '%ECONOM%'  OR 
  gkg.V2Themes LIKE '%BUSINESS%' OR 
  gkg.V2Themes LIKE '%MARKET%'
)
LIMIT 8000;
