-- es
WITH spanish_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier,
    ARRAY_AGG(MentionTimeDate ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS MentionTimeDate
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:spa%'  -- 原文为西班牙语
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
chinese_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:zho%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
english_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE (MentionDocTranslationInfo = '' OR MentionDocTranslationInfo IS NULL) 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
arabic_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:ara%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
)
SELECT
  es.DocumentIdentifier AS DocumentIdentifier,   -- 西班牙语新闻 URL
  gkg.V2Themes,
  gkg.V2Tone,
  gkg.GCAM,
  es.GLOBALEVENTID,
  CONCAT(SUBSTR(CAST(es.MentionTimeDate AS STRING), 1, 4), '-',
         SUBSTR(CAST(es.MentionTimeDate AS STRING), 5, 2), '-',
         SUBSTR(CAST(es.MentionTimeDate AS STRING), 7, 2)) AS ts,
  'es' AS lang,
  'es' AS src_lang,
  zh.DocumentIdentifier AS url_zh,  -- 对应事件的中文报道 URL
  en.DocumentIdentifier AS url_en,  -- 对应事件的英文报道 URL
  ar.DocumentIdentifier AS url_ar   -- 对应事件的阿拉伯文报道 URL
FROM spanish_docs es
JOIN chinese_docs zh ON es.GLOBALEVENTID = zh.GLOBALEVENTID
JOIN english_docs en ON es.GLOBALEVENTID = en.GLOBALEVENTID
JOIN arabic_docs ar  ON es.GLOBALEVENTID = ar.GLOBALEVENTID
JOIN `gdelt-bq.gdeltv2.gkg_partitioned` gkg 
     ON es.DocumentIdentifier = gkg.DocumentIdentifier
WHERE (
  gkg.V2Themes LIKE '%FINANCE%' OR 
  gkg.V2Themes LIKE '%ECONOM%'  OR 
  gkg.V2Themes LIKE '%BUSINESS%' OR 
  gkg.V2Themes LIKE '%MARKET%'
)
LIMIT 8000;
