-- arabic anchor 
WITH arabic_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier,
    ARRAY_AGG(MentionTimeDate ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS MentionTimeDate
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:ara%'  -- orig= arab
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
chinese_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:zho%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
english_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE (MentionDocTranslationInfo = '' OR MentionDocTranslationInfo IS NULL) 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
),
spanish_docs AS (
  SELECT 
    GLOBALEVENTID,
    ARRAY_AGG(MentionIdentifier ORDER BY MentionTimeDate ASC LIMIT 1)[OFFSET(0)] AS DocumentIdentifier
  FROM `gdelt-bq.gdeltv2.eventmentions_partitioned`
  WHERE MentionDocTranslationInfo LIKE 'srclc:spa%' 
    AND MentionTimeDate >= 20220101000000 AND MentionTimeDate < 20250101000000
  GROUP BY GLOBALEVENTID
)
SELECT
  ar.DocumentIdentifier AS DocumentIdentifier,   
  gkg.V2Themes,
  gkg.V2Tone,
  gkg.GCAM,
  ar.GLOBALEVENTID,
  CONCAT(SUBSTR(CAST(ar.MentionTimeDate AS STRING), 1, 4), '-',
         SUBSTR(CAST(ar.MentionTimeDate AS STRING), 5, 2), '-',
         SUBSTR(CAST(ar.MentionTimeDate AS STRING), 7, 2)) AS ts,
  'ar' AS lang,
  'ar' AS src_lang,
  zh.DocumentIdentifier AS url_zh,  -- same event but zh URL
  en.DocumentIdentifier AS url_en,  -- en URL
  es.DocumentIdentifier AS url_es   -- es URL
FROM arabic_docs ar
JOIN chinese_docs zh ON ar.GLOBALEVENTID = zh.GLOBALEVENTID
JOIN english_docs en ON ar.GLOBALEVENTID = en.GLOBALEVENTID
JOIN spanish_docs es ON ar.GLOBALEVENTID = es.GLOBALEVENTID
JOIN `gdelt-bq.gdeltv2.gkg_partitioned` gkg 
     ON ar.DocumentIdentifier = gkg.DocumentIdentifier
WHERE (
  gkg.V2Themes LIKE '%FINANCE%' OR 
  gkg.V2Themes LIKE '%ECONOM%'  OR 
  gkg.V2Themes LIKE '%BUSINESS%' OR 
  gkg.V2Themes LIKE '%MARKET%'
)
LIMIT 8000;
